# RAG 평가 틀린 문제 분석 및 개선 방안

## 틀린 문제 요약

### 1. 답변 추출 실패 (Pred: None)
- **Q6**: 1980학년도 이전 입학생 성적점 등급 문제
- **Q8**: 복수전공 신청 자격 문제
- **Q28, Q30, Q31, Q33**: Wikipedia 관련 문제들

### 2. 잘못된 답변 추출
- **Q7**: 사회체육학과 학위 (Pred: B, Gold: D) - LLM이 잘못 해석
- **Q14**: 전공과목 구분 (Pred: A, Gold: C) - 여러 선택지가 응답에 포함되어 첫 번째 추출
- **Q24**: 학점 관련 문제 (Pred: C, Gold: D) - 잘못된 답변
- **Q29**: Wikipedia 문제 (Pred: B, Gold: I) - 답변 추출 실패
- **Q34**: Kohlberg 도덕 발달 (Pred: G, Gold: E) - Wikipedia 검색 부족
- **Q38**: 법률 문제 (Pred: I, Gold: D) - Wikipedia 검색 부족

### 3. API 에러 (429)
- **Q35, Q37**: API 요청 한도 초과

---

## 문제별 상세 분석

### Q6: 1980학년도 이전 입학생 성적점 등급
**문제**: 응답이 비어있거나 추출 실패
**원인**: 부칙에 정보가 있을 가능성이 높지만 검색되지 않음
**개선 방안**:
1. 부칙 청킹 크기 조정 (더 작은 청크로 분할)
2. 부칙 검색 가중치 증가
3. "1980", "성적점", "등급" 키워드 기반 검색 강화

### Q7: 사회체육학과 학위
**문제**: LLM이 "(B) 문학사"로 잘못 답변 (실제는 "(D) 이학사")
**원인**: 
- Wikipedia 문서가 너무 많이 검색되어 혼란 (198개)
- "사회체육학"과 "사회학"이 혼동됨
**개선 방안**:
1. Wikipedia 검색 결과 수 제한 (최대 3-5개)
2. 이화여대 학칙 문서에 가중치 부여
3. 프롬프트에 "이화여대 학칙을 우선 참고" 지시 추가

### Q8: 복수전공 신청 자격
**문제**: "The information is not present in the context"
**원인**: PDF 본문에 정보가 있을 가능성이 높지만 검색되지 않음
**개선 방안**:
1. "복수전공", "신청 자격" 키워드 기반 검색 강화
2. 청킹 크기 조정 (더 작은 청크로 분할)
3. Top-k 검색 수 증가 (5 → 10)

### Q14: 전공과목 구분
**문제**: 응답에 "(A)"와 "(C)" 둘 다 포함되어 첫 번째 추출
**원인**: extract_answer 함수가 첫 번째 선택지만 추출
**개선 방안**:
1. extract_answer 함수 개선: 응답 전체를 분석하여 가장 확실한 답변 추출
2. 프롬프트 개선: "정확히 하나의 선택지만 답변하세요" 지시 추가

### Q24: 학점 관련 문제
**문제**: 잘못된 답변 (C) 추출
**원인**: 컨텍스트 해석 오류
**개선 방안**:
1. 프롬프트 개선: "정확한 조항을 인용하여 답변하세요" 추가
2. 검색된 문서의 관련성 점수 확인

### Q28-Q33: Wikipedia 관련 문제들
**문제**: "The information is not present in the context" 또는 잘못된 답변
**원인**:
1. Wikipedia 키워드 추출 실패
2. Wikipedia 문서 검색 실패
3. 검색된 문서가 관련성 낮음
**개선 방안**:
1. 키워드 추출 로직 개선:
   - 질문에서 직접 키워드 추출 (예: "Homo sapiens" → "Human evolution", "Psychology")
   - 더 많은 학문 분야 키워드 추가
2. Wikipedia 검색 개선:
   - 검색 실패 시 대체 키워드 시도
   - 검색 결과 수 제한 (너무 많으면 혼란)
3. 프롬프트 개선:
   - Wikipedia 문서와 이화여대 학칙을 구분하여 사용
   - "Wikipedia 문서는 일반적인 학문 지식, 이화여대 학칙은 구체적인 규정" 명시

### Q34, Q38: Wikipedia 문제 (잘못된 답변)
**문제**: Wikipedia 검색은 되었지만 잘못된 답변
**원인**: 검색된 문서가 관련성 낮거나 LLM이 잘못 해석
**개선 방안**:
1. Wikipedia 문서 필터링: 관련성 높은 문서만 사용
2. 검색 결과 수 제한
3. 프롬프트에 "정확한 정보만 사용" 지시 추가

---

## 종합 개선 방안

### 1. extract_answer 함수 개선
```python
def extract_answer(response: str) -> Optional[str]:
    """
    응답에서 답변 추출 개선 버전
    - 여러 선택지가 있을 경우 가장 확실한 것 선택
    - "정답:", "Answer:", "답:" 등의 키워드 우선
    """
    # 우선순위 1: 명시적인 정답 표시
    patterns = [
        r"정답[:\s]*\(([A-Z])\)",
        r"Answer[:\s]*\(([A-Z])\)",
        r"답[:\s]*\(([A-Z])\)",
        r"\[ANSWER\]:\s*\(([A-Z])\)",
    ]
    for pattern in patterns:
        match = re.search(pattern, response, re.IGNORECASE)
        if match:
            return match.group(1)
    
    # 우선순위 2: (X) 형식 (마지막 발생)
    pattern2 = r"\(([A-Z])\)"
    matches = list(re.finditer(pattern2, response))
    if matches:
        # 여러 개가 있으면 마지막 것 (보통 최종 답변)
        return matches[-1].group(1)
    
    # 우선순위 3: 단독 문자
    pattern3 = r"\b([A-Z])\b"
    matches = list(re.finditer(pattern3, response, re.IGNORECASE))
    if matches:
        return matches[-1].group(1).upper()
    
    return None
```

### 2. Wikipedia 키워드 추출 개선
```python
def extract_wikipedia_keywords(question: str) -> List[str]:
    """
    질문에서 Wikipedia 검색 키워드 추출 개선
    - 영어 질문에서 직접 키워드 추출
    - 학문 분야 키워드 매핑 확장
    """
    keywords = []
    
    # 영어 질문에서 직접 키워드 추출
    if any(ord(c) < 128 for c in question):  # 영어 포함
        # 학문 분야 키워드
        academic_keywords = {
            'Homo': 'Human evolution',
            'sapiens': 'Human evolution',
            'bipolar': 'Psychology',
            'disorder': 'Psychology',
            'Kohlberg': 'Moral development',
            'Kant': 'Philosophy',
            'Aristotle': 'Philosophy',
            'jurisprudence': 'Law',
            'larceny': 'Law',
            'criminal': 'Law',
        }
        
        for key, value in academic_keywords.items():
            if key.lower() in question.lower():
                keywords.append(value)
    
    # 기존 한국어 키워드 매핑도 유지
    # ...
    
    return list(set(keywords))
```

### 3. 프롬프트 템플릿 개선
```python
prompt_template = PromptTemplate.from_template(
    """
    다음 문맥을 바탕으로 질문에 가장 정확하게 답변하세요.
    
    **중요 지침:**
    1. 이화여대 학칙 문서를 우선 참고하세요 (구체적인 규정)
    2. Wikipedia 문서는 일반적인 학문 지식 참고용입니다
    3. 정확히 하나의 선택지만 답변하세요
    4. 답변 형식: "정답: (X)" 또는 "(X)" 형식으로 답변
    
    답변이 문맥에 없다면 정확히 "The information is not present in the context."라고 답변하세요.
    
    ---
    Question: {question}
    ---
    Context:
    {context}
    """
)
```

### 4. 검색 개선
- Top-k 검색 수 증가: 5 → 10 (특히 이화여대 학칙 문서)
- Wikipedia 검색 결과 수 제한: 최대 3-5개
- 검색 결과 관련성 필터링

### 5. API 에러 처리
- 재시도 로직 추가 (exponential backoff)
- 요청 간격 조절
- 배치 처리로 API 호출 수 감소

---

## 우선순위별 개선 작업

### 높은 우선순위 (즉시 개선)
1. ✅ extract_answer 함수 개선 (Q14 해결)
2. ✅ Wikipedia 키워드 추출 개선 (Q28-Q33 해결)
3. ✅ 프롬프트 템플릿 개선 (전반적 정확도 향상)

### 중간 우선순위
4. Wikipedia 검색 결과 수 제한 (Q7 해결)
5. Top-k 검색 수 증가 (Q8 해결)
6. 부칙 청킹 개선 (Q6 해결)

### 낮은 우선순위
7. API 재시도 로직 (Q35, Q37 해결)
8. 검색 결과 관련성 필터링

